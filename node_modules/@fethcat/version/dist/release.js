"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.release = exports.confirmRelease = void 0;
const readline_1 = require("readline");
const config_1 = require("./config");
const extract_1 = require("./extract");
const git_1 = require("./git");
const logger_1 = require("./logger");
function confirmRelease(fromVersion, toVersion) {
    (0, logger_1.logInfo)(`Creating version ${toVersion} from ${fromVersion}`);
    const rl = (0, readline_1.createInterface)(process.stdin, process.stdout);
    return new Promise((resolve) => {
        rl.question("Continue with this version? Y/N ", (answer) => {
            rl.close();
            if ((answer || "Y").toUpperCase() !== "Y") {
                (0, logger_1.logInfo)("Aborting release");
                resolve(false);
            }
            resolve(true);
        });
    });
}
exports.confirmRelease = confirmRelease;
async function release(env, codeVersion) {
    if (!codeVersion)
        codeVersion = await (0, extract_1.extractVersion)();
    const fromVersion = `v${codeVersion}`;
    const toVersion = config_1.tagPrefix[env] + codeVersion;
    if (await confirmRelease(fromVersion, toVersion)) {
        await git_1.git.checkout(fromVersion);
        await git_1.git.tag(toVersion);
        await git_1.git.push(`origin ${toVersion}`);
        await git_1.git.checkout("-");
        (0, logger_1.logSuccess)(`Successfully released ${env} ${toVersion}`);
    }
}
exports.release = release;
